<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Seguimiento</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 0; }
        .header { background-color: #343a40; padding: 10px 30px; display: flex; align-items: center; gap: 15px; }
        .header img { height: 40px; }
        .header-title { color: #ffffff; font-size: 1.5em; margin: 0; font-weight: 500; }
        .main-content { display: flex; justify-content: center; padding: 20px; }
        .container { background-color: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 95%; box-sizing: border-box; }
        h1, h2, h3 { color: #0d47a1; }
        hr { border: 0; border-top: 1px solid #eee; margin: 30px 0; }
        .hidden { display: none !important; }
        #login-wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #login-container { text-align: center; max-width: 400px; width: 100%; }
        #login-container input, #login-container button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1em; }
        #login-container button { background-color: #0d47a1; color: white; border: none; cursor: pointer; }
        #login-error { color: #e53935; font-weight: bold; min-height: 1.2em; }
        .tab-nav { border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab-button { background-color: transparent; border: none; padding: 10px 20px; cursor: pointer; font-size: 1.1em; color: #555; border-bottom: 3px solid transparent; }
        .tab-button.active { color: #0d47a1; border-bottom: 3px solid #0d47a1; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #1a237e; color: white; }
        .tracker h2 { text-align: center; }
        .info { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px 20px; text-align: left; }
        .resumen { background-color: #fdfdfd; border: 1px solid #eaeaea; border-radius: 8px; padding: 20px; margin-bottom: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px 20px; }
        #filtros { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; align-items: center; }
        select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
        .message-box { text-align: center; color: #555; font-weight: bold; margin-top: 20px; font-size: 1.1em; padding: 20px; background-color: #fafafa; border-radius: 8px; }
        #historial-layout { display: flex; flex-wrap: wrap; gap: 30px; }
        #historial-datos { flex: 2; min-width: 450px; }
        #historial-graficos-container { flex: 1; min-width: 350px; display: flex; flex-direction: column; gap: 30px;}
        .progress-display { background-color: #fdfdfd; border: 1px solid #eaeaea; border-radius: 8px; padding: 20px; margin-top: 10px; margin-bottom: 25px; width: 100%; box-sizing: border-box; }
        .progress-bar-wrapper { width: 100%; position: relative; overflow-x: auto; overflow-y: hidden; padding-top: 40px; margin-bottom: 20px; }
        .progress-bar { position: relative; width: 5000px; background-color: #e0e0e0; border-radius: 8px; height: 30px; }
        .progress { width: 0%; height: 100%; background-color: #4caf50; transition: width 0.5s ease-in-out; text-align: center; line-height: 30px; color: white; font-weight: bold; z-index: 1; position: relative; border-radius: 8px 0 0 8px; }
        #pig-container { position: absolute; height: 100%; top: 0; z-index: 3; transition: left 0.5s ease-in-out; display: flex; align-items: center; }
        .pig-indicator { position: relative; width: 21px; height: 21px; background-color: #e53935; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); animation: blink 1.2s infinite; cursor: pointer; }
        .pig-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 10px; background-color: #333; color: white; padding: 6px 12px; border-radius: 5px; font-size: 14px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity .2s ease, visibility .2s ease; z-index: 11; }
        #pig-container:hover .pig-tooltip { opacity: 1; visibility: visible; }
        @keyframes blink { 50% { opacity: .2; } }
        .checkpoint-marker-container { position: absolute; top: 0; bottom: 0; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; z-index: 2; }
        .checkpoint-marker { width: 3px; height: 100%; background-color: #0d47a1; cursor: pointer; }
        .tooltip { position: absolute; bottom: 100%; margin-bottom: 8px; background-color: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity .2s ease, visibility .2s ease; z-index: 10; }
        .checkpoint-marker-container:hover .tooltip { opacity: 1; visibility: visible; }
        tr.highlight { background-color: #dcedc8; font-weight: bold; }
        .horario-estimado { font-style: italic; color: #666; }
        .timer-display { background-color: #fffde7; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; font-size: 1.2em; font-weight: bold; text-align: center; grid-column: 1 / -1; color: #5d4037; }
        .footer { font-size: 0.8em; color: #777; text-align: right; margin-top: 15px; }
        .lista-corridas-activas { display: flex; flex-direction: column; gap: 10px; }
        .corrida-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px 20px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; }
        .corrida-item:hover { background-color: #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .corrida-item h3 { margin: 0 0 5px 0; color: #0d47a1; }
        .corrida-item p { margin: 0; color: #495057; }
        .btn-volver { background-color: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .btn-volver:hover { background-color: #5a6268; }
        #programacion-layout { display: flex; flex-wrap: wrap; gap: 30px; }
        #programacion-calendario { flex: 3; min-width: 400px; }
        #programacion-resumen { flex: 2; min-width: 350px; }
        .ducto-card { background-color: #fff; border: 1px solid #e0e0e0; border-left: 5px solid #1e88e5; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ducto-card h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .ducto-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .ducto-card-grid p { margin: 0; font-size: 0.9em; }
        .ducto-card-grid strong { color: #333; }
        .status-ok { color: #388e3c; }
        .status-due { color: #f57c00; font-weight: bold; }
        .status-overdue { color: #d32f2f; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-header, .calendar-day { text-align: center; padding: 10px; border-radius: 4px; }
        .calendar-header { background-color: #1a237e; color: white; font-weight: bold; }
        .calendar-day { background-color: #f5f5f5; min-height: 80px; font-size: 0.8em; }
        .calendar-day.other-month { color: #ccc; }
        .calendar-day .day-number { font-weight: bold; font-size: 1.2em; }
        .calendar-event { background-color: #1e88e5; color: white; padding: 3px 5px; border-radius: 3px; font-size: 0.85em; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #logout-btn {
            margin-left: auto; 
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
        }
        #logout-btn:hover {
            background-color: #c82333;
        }

        #chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #chat-bubble {
            width: 60px;
            height: 60px;
            background-color: #0d47a1;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        #chat-bubble:hover {
            transform: scale(1.1);
        }

        #chat-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 370px;
            max-width: 90vw;
            height: 500px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.3s, transform 0.3s;
        }

        #chat-container.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .chat-header {
            background: #1a237e;
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.4;
        }

        .chat-message.user {
            background-color: #e3f2fd;
            color: #0d47a1;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-message.bot {
            background-color: #f1f3f4;
            color: #3c4043;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-message.bot.thinking {
            font-style: italic;
            color: #888;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid #eee;
            padding: 10px;
        }

        .chat-input input {
            flex-grow: 1;
            border: none;
            padding: 10px;
            font-size: 1em;
            outline: none;
        }

        .chat-input button {
            background: #0d47a1;
            border: none;
            color: white;
            padding: 0 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="login-wrapper">
        <div class="container" id="login-container">
            <h1>Iniciar Sesión</h1>
            <form id="login-form">
                <input type="text" id="username" placeholder="Usuario" required>
                <input type="password" id="password" placeholder="Contraseña" required>
                <button type="submit">Ingresar</button>
                <p id="login-error"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="header">
            <img src="logo.png" alt="Logo Empresa">
            <h2 class="header-title">Dashboard PC</h2>
            <button id="logout-btn">Cerrar Sesión</button>
        </div>
        <div class="main-content">
            <div class="container">
                <div class="tab-nav">
                    <button class="tab-button active" onclick="openTab(event, 'vivo')">Seguimiento en Vivo</button>
                    <button class="tab-button" onclick="openTab(event, 'historial')">Historial de Corridas</button>
                    <button class="tab-button" onclick="openTab(event, 'programacion')">Programación</button>
                </div>

                <div id="vivo" class="tab-content active">
                    <div class="tracker">
                        <h2>Seguimiento en Vivo</h2>
                        <div id="lista-corridas-container">
                            <div class="message-box"><p>Buscando corridas activas...</p></div>
                        </div>
                        <div id="detalle-corrida-container" class="hidden"></div>
                    </div>
                </div>

                <div id="historial" class="tab-content">
                    <div id="filtros">
                        <label for="ducto-select">Ducto:</label>
                        <select id="ducto-select"><option value="">Cargando...</option></select>
                        <label for="corrida-select">Nº de Corrida:</label>
                        <select id="corrida-select" disabled><option value="">Seleccione ducto</option></select>
                    </div>
                    <div id="mensaje"><p>Seleccione un ducto y una corrida para ver los detalles.</p></div>
                    <div id="resultados-container" class="hidden">
                        <div id="historial-layout">
                            <div id="historial-datos">
                                <div id="resumen-corrida" class="resumen"></div><hr>
                                <h2>Detalle de Checkpoints</h2>
                                <table id="tabla-historico">
                                    <thead><tr><th>Checkpoint</th><th>Progresiva [mts]</th><th>Horario Pasada</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="historial-graficos-container">
                                <div id="historial-grafico-velocidad">
                                    <h2>Perfil de Velocidad</h2>
                                    <div id="grafico-historico-container"><canvas id="velocityChartHistorico"></canvas></div>
                                </div>
                                <hr>
                                <div id="historial-grafico-suciedad">
                                    <h2>Residuos Recolectados</h2>
                                    <div id="grafico-suciedad-container"><canvas id="suciedadChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="programacion" class="tab-content">
                    <div id="programacion-layout">
                        <div id="programacion-calendario">
                            <h2>Calendario de Próximas Limpiezas</h2>
                            <div id="calendario-controles">
                                <button id="prev-month">&lt;</button>
                                <h3 id="calendar-title" style="display: inline-block; margin: 0 20px;"></h3>
                                <button id="next-month">&gt;</button>
                            </div>
                            <div id="calendar-grid" class="calendar-grid"></div>
                        </div>
                        <div id="programacion-resumen">
                            <h2>Resumen de Ductos</h2>
                            <div id="resumen-ductos-container">
                                <div class="message-box"><p>Cargando resúmenes...</p></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="chat-widget">
        <div id="chat-container" class="hidden">
            <div class="chat-header">Asistente de Corridas</div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-message bot">Hola, ¿cómo puedo ayudarte con la información de las corridas de limpieza?</div>
            </div>
            <form class="chat-input" id="chat-form">
                <input type="text" id="chat-input-text" placeholder="Escribe tu pregunta..." autocomplete="off">
                <button type="submit">Enviar</button>
            </form>
        </div>
        <div id="chat-bubble">💬</div>
    </div>
    
    <script>
        // --- Variables Globales ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhSBRqZgnhT2qSRicW1y1j0y-GASJOggKlSgQJJ4SUUcYVEtXHqSWVPzopWn80JMVy_g/exec";
        function crearRespuestaJSON(t, e = 200) {
    return ContentService.createTextOutput(JSON.stringify(t)).setMimeType(ContentService.MimeType.JSON);
}
        let timerInterval;
        let detalleInterval;
        let activeTimers = { proximo: 0, final: 0 };
        let primeraCargaDetalle = {};
        let historicoChart, suciedadChart;
        let programacionCargada = false;
        let calendarioData = [];
        let currentCalendarDate = new Date();
        let conversationHistory = [];

        // --- Lógica de Inicialización y Login ---
        document.addEventListener('DOMContentLoaded', () => { if (sessionStorage.getItem('authToken')) { mostrarAplicacion(); } else { document.getElementById('login-wrapper').classList.remove('hidden'); } });
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const l=document.getElementById('login-error'); l.textContent='Verificando...'; try { const r = await fetch(`${SCRIPT_URL}?action=login&user=${encodeURIComponent(username.value)}&pass=${encodeURIComponent(password.value)}`), s = await r.json(); if (s.status==='success'&&s.token){sessionStorage.setItem('authToken',s.token); mostrarAplicacion();} else {l.textContent=s.message||'Error al iniciar sesión.';}} catch (e){l.textContent='Error de conexión.';}});
        function mostrarAplicacion() { document.getElementById('login-wrapper').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); iniciarDashboard(); }
        function iniciarDashboard() { setInterval(cargarCorridasActivas, 60000); cargarCorridasActivas(); iniciarTimers(); cargarDuctos(); document.getElementById('ducto-select').addEventListener('change', cargarCorridas); document.getElementById('corrida-select').addEventListener('change', cargarResultados); document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1)); document.getElementById('next-month').addEventListener('click', () => changeMonth(1)); document.getElementById('logout-btn').addEventListener('click', () => { sessionStorage.removeItem('authToken'); location.reload(); });}
        function openTab(e,t){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active"));document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active"));document.getElementById(t).classList.add("active");e.currentTarget.classList.add("active");if(t==='programacion'&&!programacionCargada){cargarProgramacion();}}
        async function fetchSeguro(e,t=null){const n=sessionStorage.getItem("authToken");if(!n){location.reload();return Promise.reject("No token")}let a=`${SCRIPT_URL}?action=${e}&token=${n}`;if(t){a+=`&id=${t}`}const o=await fetch(a);if(!o.ok){if(o.status===401){sessionStorage.removeItem("authToken");location.reload()}const r=await o.json();throw new Error(r.error||`Error: ${o.status}`)}return o.json()}
        function iniciarTimers() { if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(()=>{actualizarDisplayTimer('timer-proximo-detalle', activeTimers.proximo); actualizarDisplayTimer('timer-final-detalle', activeTimers.final);}, 1000); }
        function actualizarDisplayTimer(e,t){const n=document.getElementById(e);if(n){if(!t||t<=0){n.textContent="--:--:--";return}const a=t-Date.now();if(a<=0){n.textContent="00:00:00";return}const o=String(Math.floor(a/36e5)).padStart(2,"0"),r=String(Math.floor(a%36e5/6e4)).padStart(2,"0"),s=String(Math.floor(a%6e4/1e3)).padStart(2,"0");n.textContent=`${o}:${r}:${s}`}}
        
        // --- Funciones del Dashboard ---
        async function cargarCorridasActivas() { const d=document.getElementById('detalle-corrida-container');if(!d.classList.contains('hidden'))return;const c=document.getElementById('lista-corridas-container');try{const a=await fetchSeguro('getVivo');if(a.error)throw new Error(a.error);if(a.ultimaCorrida){c.innerHTML=`<div class="message-box"><p>No hay limpiezas activas.<br><br><strong>Última corrida finalizada:</strong><br>Nº: ${a.ultimaCorrida.numeroLimpieza} | Ducto: ${a.ultimaCorrida.nombreDucto}<br>Finalizó el ${a.ultimaCorrida.fecha} a las ${a.ultimaCorrida.hora} hs.<br>Duración Total: ${a.ultimaCorrida.duracion}</p></div>`;return}if(Array.isArray(a)&&a.length>0){c.innerHTML=`<h3>Seleccione una corrida para ver el detalle:</h3>`;const e=document.createElement('div');e.className='lista-corridas-activas';a.forEach(t=>{const n=document.createElement('div');n.className='corrida-item';n.dataset.id=t.id;n.innerHTML=`<h3>Nº ${t.nro}</h3><p>${t.nombreDucto}</p>`;n.addEventListener('click',()=>mostrarDetalleVivo(t.id));e.appendChild(n)});c.appendChild(e)}else{c.innerHTML=`<div class="message-box"><p>No se encontraron corridas activas.</p></div>`}}catch(t){c.innerHTML=`<div class="message-box"><p style="color:red;">Error al cargar corridas: ${t.message}</p></div>`}}
        async function mostrarDetalleVivo(e){if(detalleInterval)clearInterval(detalleInterval);document.getElementById('lista-corridas-container').classList.add('hidden');const t=document.getElementById('detalle-corrida-container');t.classList.remove('hidden');t.innerHTML=`
                <button id="btn-volver-lista" class="btn-volver">&larr; Volver a la lista</button><div class="progress-display"><h3 id="detalle-ducto-nombre" style="text-align:center; margin-top:0;">Cargando...</h3><div class="progress-bar-wrapper"><div class="progress-bar" id="progress-bar-container"><div id="progress-fill" class="progress"></div><div id="pig-container"><div class="pig-indicator"></div><div class="pig-tooltip" id="pig-tooltip-text"></div></div></div></div><p class="footer">Última actualización: <span id="update-time">--:--:--</span></p></div><div class="info"><p><strong>Nº Limpieza:</strong> <span id="detalle-nro-limpieza"></span></p> <p><strong>Estado:</strong> <span id="detalle-estado"></span></p><p><strong>Velocidad (est.):</strong> <span id="velocidad-detalle"></span></p> <p><strong>Progresiva (est.):</strong> <span id="progresiva-detalle"></span> mts</p><p><strong>Método Cálculo:</strong> <span id="detalle-metodo"></span></p> <p><strong>ETA Receptora:</strong> <span id="detalle-eta-final"></span></p><p class="timer-display">Próximo CP (<span id="nombre-proximo-cp-detalle">...</span>) en: <span id="timer-proximo-detalle">--:--:--</span></p><p class="timer-display">Llegada a Receptora en: <span id="timer-final-detalle">--:--:--</span></p></div><table><thead><tr><th>Checkpoint</th><th>Progresiva [mts]</th><th>Horario Pasada</th></tr></thead><tbody id="puntos-tabla-body-detalle"></tbody></table>`;document.getElementById('btn-volver-lista').addEventListener('click',()=>{clearInterval(detalleInterval);t.classList.add('hidden');document.getElementById('lista-corridas-container').classList.remove('hidden');cargarCorridasActivas()});actualizarDetalleVivo(e);detalleInterval=setInterval(()=>actualizarDetalleVivo(e),30000)}
        async function actualizarDetalleVivo(e){try{const t=await fetchSeguro('getDetalleVivo',e);if(!t||t.error){throw new Error(t?t.error:"No se recibieron datos.")}
        document.getElementById('detalle-ducto-nombre').textContent=t.nombreDucto;document.getElementById('detalle-nro-limpieza').textContent=t.numeroLimpieza;document.getElementById('detalle-estado').textContent=t.estado;document.getElementById('velocidad-detalle').textContent=t.estimacion.velocidad_ms?`${(t.estimacion.velocidad_ms*3.6).toFixed(2)} km/h`:'---';document.getElementById('progresiva-detalle').textContent=Math.round(t.estimacion.progresivaEstimadaMts).toLocaleString('es-AR');document.getElementById('detalle-metodo').textContent=t.estimacion.metodoCalculo;document.getElementById('detalle-eta-final').textContent=t.estimacion.etaFinal?t.estimacion.etaFinal.hora:'---';document.getElementById('update-time').textContent=(new Date).toLocaleTimeString('es-AR');const n=document.getElementById('progress-fill');n.style.width=t.avance.porcentaje+'%';n.textContent=t.avance.porcentaje.toFixed(1)+'%';document.getElementById('pig-container').style.left=`calc(${t.avance.porcentaje}% - 10.5px)`;document.getElementById('pig-tooltip-text').textContent=`${Math.round(t.estimacion.progresivaEstimadaMts).toLocaleString('es-AR')} mts`;activeTimers.proximo=t.estimacion.etaProximo?t.estimacion.etaProximo.timestamp:0;activeTimers.final=t.estimacion.etaFinal?t.estimacion.etaFinal.timestamp:0;document.getElementById('nombre-proximo-cp-detalle').textContent=t.estimacion.etaProximo?t.estimacion.etaProximo.nombre:'...';const a=document.getElementById('puntos-tabla-body-detalle');a.innerHTML='';const o=document.getElementById('progress-bar-container');if(primeraCargaDetalle[e]){o.querySelectorAll('.checkpoint-marker-container').forEach(e=>e.remove())}
        t.listaDePuntos.forEach(n=>{if(!primeraCargaDetalle[e]&&t.longitudTotalMts>0){const a=n.progresiva/t.longitudTotalMts*100,r=document.createElement('div');r.className='checkpoint-marker-container';r.style.left=a+'%';r.innerHTML=`<div class="checkpoint-marker"></div><div class="tooltip">${n.nombre}</div>`;o.appendChild(r)}const s=document.createElement('tr'),i=n.horaPasada?n.horaPasada.includes('(')?`<span class="horario-estimado">${n.horaPasada}</span>`:n.horaPasada:'---';s.innerHTML=`<td>${n.nombre}</td><td>${n.progresiva.toLocaleString('es-AR')}</td><td>${i}</td>`;if(t.ultimoPunto&&t.ultimoPunto.nombre===n.nombre)s.classList.add('highlight');a.appendChild(s)});if(!primeraCargaDetalle[e]){const c=document.querySelector('.progress-bar-wrapper');c.scrollTo({left:c.scrollWidth*(t.avance.porcentaje/100)-c.clientWidth/2,behavior:'auto'});primeraCargaDetalle[e]=true}}catch(r){document.getElementById('update-time').textContent=`Error: ${r.message}`;clearInterval(detalleInterval)}}
        async function cargarDuctos(){try{const e=await fetchSeguro('getDuctos'),t=document.getElementById('ducto-select');t.innerHTML='<option value="">Seleccione un ducto</option>';e.forEach(n=>{t.innerHTML+=`<option value="${n.id}">${n.nombre}</option>`})}catch(e){document.getElementById('mensaje').innerHTML=`<p style="color: red;">Error al cargar ductos: ${e.message}</p>`}}
        async function cargarCorridas(){const e=document.getElementById('ducto-select').value,t=document.getElementById('corrida-select'),n=document.getElementById('mensaje');document.getElementById('resultados-container').classList.add('hidden');t.disabled=true;t.innerHTML='<option value="">Cargando...</option>';n.classList.remove('hidden');if(!e){t.innerHTML='<option value="">Seleccione un ducto</option>';return}try{const[a,o]=await Promise.all([fetchSeguro('getCorridas',e),fetchSeguro('getSuciedadHistorico',e)]);if(!Array.isArray(a))throw new Error(a.error||"Datos de corridas no válidos.");if(!Array.isArray(o))throw new Error(o.error||"Datos de suciedad no válidos.");if(a.length===0){t.innerHTML='<option value="">No hay corridas</option>'}else{t.innerHTML='<option value="">Seleccione una corrida</option>';a.forEach(e=>{t.innerHTML+=`<option value="${e.id}">Nº ${e.nro} (${e.fecha})</option>`});t.disabled=false}drawSuciedadChart(o)}catch(r){n.innerHTML=`<p style="color: red;">Error al cargar datos del ducto: ${r.message}</p>`}}
        async function cargarResultados(){const e=document.getElementById('corrida-select').value,t=document.getElementById('resultados-container'),n=document.getElementById('mensaje');if(!e){t.classList.add('hidden');return}n.innerHTML='<p>Cargando datos...</p>';n.classList.remove('hidden');try{const a=await fetchSeguro('getHistorico',e);if(a.error)throw new Error(a.error);document.getElementById('resumen-corrida').innerHTML=`<p><strong>Ducto:</strong> ${a.resumen.nombreDucto}</p><p><strong>Nº Limpieza:</strong> ${a.resumen.nroLimpieza}</p><p><strong>Fecha:</strong> ${a.resumen.fecha}</p><p><strong>Duración Total:</strong> ${a.resumen.duracion}</p>`;const o=document.querySelector('#tabla-historico tbody');o.innerHTML='';a.tabla.forEach(e=>{o.innerHTML+=`<tr><td>${e.nombre}</td><td>${e.progresiva.toLocaleString('es-AR')}</td><td>${e.horario}</td></tr>`});drawHistoricoChart(a.checkpoints);n.classList.add('hidden');t.classList.remove('hidden')}catch(r){n.innerHTML=`<p style="color: red;">Error al cargar resultados: ${r.message}</p>`;t.classList.add('hidden')}}
        function drawHistoricoChart(e){const t=document.getElementById('velocityChartHistorico');if(historicoChart){historicoChart.destroy()}if(!e||e.length<2){if(t){t.getContext('2d').clearRect(0,0,t.width,t.height)}return}const n=[],a=[];for(let o=1;o<e.length;o++){const r=e[o-1],s=e[o],i=s.progresiva_mts-r.progresiva_mts,l=(new Date(s.fechaHora).getTime()-(new Date(r.fechaHora).getTime()))/1e3;if(l>0&&i>0){n.push(`${r.nombre} -> ${s.nombre}`);a.push((i/l*3.6).toFixed(2))}}historicoChart=new Chart(t,{type:'bar',data:{labels:n,datasets:[{type:'bar',label:'Velocidad (km/h)',data:a,backgroundColor:'rgba(26, 35, 126, 0.6)'},{type:'line',label:'Tendencia',data:a,borderColor:'#e53935',fill:false}]},options:{scales:{y:{beginAtZero:true,title:{display:true,text:'Velocidad (km/h)'}}},plugins:{legend:{display:false}}}})}
        function drawSuciedadChart(e){const t=document.getElementById('suciedadChart');if(suciedadChart){suciedadChart.destroy()}if(!e||e.length===0){if(t){t.getContext('2d').clearRect(0,0,t.width,t.height)}return}const n=e.map(t=>`Nº ${t.nro} (${t.fecha})`),a=e.map(e=>e.suciedadKg);suciedadChart=new Chart(t,{type:'bar',data:{labels:n,datasets:[{label:'Suciedad (kg)',data:a,backgroundColor:'rgba(139, 69, 19, 0.6)'}]},options:{scales:{y:{beginAtZero:true,title:{display:true,text:'Residuos (kg)'}}},plugins:{legend:{display:false}}}})}
        async function cargarProgramacion(){const e=document.getElementById('resumen-ductos-container');try{e.innerHTML=`<div class="message-box"><p>Calculando programación...</p></div>`;calendarioData=await fetchSeguro('getProgramacionData');if(Array.isArray(calendarioData)){renderResumenDuctos(calendarioData);renderCalendario(currentCalendarDate);programacionCargada=true}else{throw new Error(calendarioData.error||"Datos de programación no válidos.")}}catch(t){e.innerHTML=`<div class="message-box"><p style="color:red;">Error al cargar la programación: ${t.message}</p></div>`}}
        function renderResumenDuctos(e){const t=document.getElementById('resumen-ductos-container');t.innerHTML='';if(!Array.isArray(e)||e.length===0){t.innerHTML=`<div class="message-box"><p>No hay ductos para mostrar.</p></div>`;return}e.sort((e,t)=>{if(!e.proximaLimpieza)return 1;if(!t.proximaLimpieza)return-1;return new Date(e.proximaLimpieza)-new Date(t.proximaLimpieza)});e.forEach(n=>{const a=document.createElement('div');a.className='ducto-card';const o=new Date;o.setHours(0,0,0,0);const r=n.proximaLimpieza?new Date(n.proximaLimpieza):null;let s='',i='OK';if(r){if(r<o){s='status-overdue';i='ATRASADA'}else if(r.getTime()===o.getTime()){s='status-due';i='VENCE HOY'}}a.style.borderLeftColor=s==='status-overdue'?'#d32f2f':s==='status-due'?'#f57c00':'#1e88e5';const l=n.tiempoPromedioMin>0?`${Math.floor(n.tiempoPromedioMin/60)}h ${n.tiempoPromedioMin%60}m`:'N/D',c=n.ultimaLimpieza?(new Date(n.ultimaLimpieza)).toLocaleDateString('es-AR'):'N/A',d=r?`${r.toLocaleDateString('es-AR')} <span class="${s}">(${i})</span>`:'No programada';a.innerHTML=`
                    <h3>${n.nombre}</h3><div class="ducto-card-grid"><p><strong>Próxima Limpieza:</strong> ${d}</p><p><strong>Última Limpieza:</strong> ${c}</p><p><strong>Frecuencia:</strong> ${n.frecuencia}</p><p><strong>Tiempo Promedio:</strong> ${l}</p><p><strong>Corridas Completas:</strong> ${n.corridasTotales}</p><p><strong>Corridas Canceladas:</strong> ${n.corridasCanceladas}</p><p><strong>Longitud:</strong> ${n.longitud.toLocaleString('es-AR')} mts</p><p><strong>Diámetro:</strong> ${n.diametro}"</p></div>`;t.appendChild(a)})}
        function renderCalendario(e){const t=document.getElementById('calendar-grid'),n=document.getElementById('calendar-title');t.innerHTML='';const a=e.getMonth(),o=e.getFullYear();n.textContent=`${e.toLocaleString('es-AR',{month:'long',year:'numeric'}).toUpperCase()}`;const r=(new Date(o,a,1)).getDay(),s=(new Date(o,a+1,0)).getDate(),i=['D','L','M','M','J','V','S'];i.forEach(e=>{t.innerHTML+=`<div class="calendar-header">${e}</div>`});for(let l=0;l<r;l++){t.innerHTML+=`<div class="calendar-day other-month"></div>`}for(let c=1;c<=s;c++){const d=document.createElement('div');d.className='calendar-day';d.innerHTML=`<div class="day-number">${c}</div>`;if(Array.isArray(calendarioData)){const u=calendarioData.filter(t=>{if(!t.proximaLimpieza)return false;const n=(new Date(t.proximaLimpieza));return n.getFullYear()===o&&n.getMonth()===a&&n.getDate()===c});u.forEach(e=>{d.innerHTML+=`<div class="calendar-event">${e.nombre}</div>`})}t.appendChild(d)}}
        function changeMonth(e){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+e);renderCalendario(currentCalendarDate)}
        
        // --- Lógica del Chat con Memoria ---
        document.addEventListener('DOMContentLoaded', () => {
            const chatBubble = document.getElementById('chat-bubble');
            const chatContainer = document.getElementById('chat-container');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input-text');
            const chatMessages = document.getElementById('chat-messages');
            if (chatBubble) {
                chatBubble.addEventListener('click', () => {
                    chatContainer.classList.toggle('hidden');
                    if (!chatContainer.classList.contains('hidden')) {
                        conversationHistory = [];
                    }
                });
            }
            if (chatForm) {
                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const userMessage = chatInput.value.trim();
                    if (!userMessage) return;
                    addMessage(userMessage, 'user');
                    chatInput.value = '';
                    addMessage('Pensando...', 'bot', true);
                    try {
                        const token = sessionStorage.getItem('authToken');
                        const historyParam = conversationHistory.length > 0 ? `&history=${encodeURIComponent(JSON.stringify(conversationHistory))}` : '';
                        const url = `${SCRIPT_URL}?action=askAI&token=${token}&question=${encodeURIComponent(userMessage)}${historyParam}`;
                        const response = await fetch(url);
                        const result = await response.json();
                        const thinkingMessage = document.querySelector('.thinking');
                        if (thinkingMessage) thinkingMessage.remove();
                        const botMessage = result.error || result.answer;
                        addMessage(botMessage, 'bot');
                        conversationHistory.push({ "role": "user", "content": userMessage });
                        conversationHistory.push({ "role": "assistant", "content": botMessage });
                    } catch (error) {
                        const thinkingMessage = document.querySelector('.thinking');
                        if (thinkingMessage) thinkingMessage.remove();
                        addMessage('Hubo un error de conexión con el asistente.', 'bot');
                    }
                });
            }
            function addMessage(text, sender, isThinking = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;
                if(isThinking) { messageDiv.classList.add('thinking'); }
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    </script>
</body>
</html>
