<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Seguimiento</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Estilos Generales */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .container { background-color: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 900px; }
        h1, h2, h3 { color: #0d47a1; }
        hr { border: 0; border-top: 1px solid #eee; margin: 30px 0; }

        /* Estilos para las Solapas (Tabs) */
        .tab-nav { border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab-button { background-color: transparent; border: none; padding: 10px 20px; cursor: pointer; font-size: 1.1em; color: #555; border-bottom: 3px solid transparent; }
        .tab-button.active { color: #0d47a1; border-bottom: 3px solid #0d47a1; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ESTILOS DE LA PÁGINA DE SEGUIMIENTO EN VIVO --- */
        .tracker h1 { text-align: center; }
        .estado-especial { display: none; background-color: #fffde7; border: 1px solid #fbc02d; color: #5d4037; padding: 15px; margin: 20px 0 10px 0; border-radius: 8px; font-weight: bold; text-align: center; }
        .export-button { background-color: #0d47a1; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9em; margin-top: 10px; transition: background-color 0.3s; float: right; }
        .export-button:hover { background-color: #1a237e; }
        .final-report-button { background-color: #43a047; margin-top: 15px; }
        .final-report-button:hover { background-color: #2e7d32; }
        .progress-display { background-color: #fdfdfd; border: 1px solid #eaeaea; border-radius: 8px; padding: 20px; margin-top: 10px; margin-bottom: 25px; width: 100%; box-sizing: border-box; }
        .progress-bar-wrapper { width: 100%; position: relative; overflow-x: auto; overflow-y: hidden; padding-top: 40px; margin-bottom: 20px; }
        .progress-bar { position: relative; width: 5000px; background-color: #e0e0e0; border-radius: 8px; height: 30px; }
        .progress { width: 0%; height: 100%; background-color: #4caf50; transition: width 0.5s ease-in-out; text-align: center; line-height: 30px; color: white; font-weight: bold; z-index: 1; position: relative; border-radius: 8px 0 0 8px; }
        #pig-container { position: absolute; height: 100%; top: 0; z-index: 3; transition: left 0.5s ease-in-out; display: flex; align-items: center; }
        .pig-indicator { position: relative; width: 21px; height: 21px; background-color: #e53935; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); animation: blink 1.2s infinite; cursor: pointer; }
        .pig-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 10px; background-color: #333; color: white; padding: 6px 12px; border-radius: 5px; font-size: 14px; font-weight: bold; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; z-index: 11; }
        #pig-container:hover .pig-tooltip { opacity: 1; visibility: visible; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
        .checkpoint-marker-container { position: absolute; top: 0; bottom: 0; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; z-index: 2; }
        .checkpoint-marker { width: 3px; height: 100%; background-color: #0d47a1; z-index: 2; cursor: pointer; }
        .tooltip { position: absolute; bottom: 100%; margin-bottom: 8px; background-color: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s ease, visibility 0.2s ease; z-index: 10; }
        .checkpoint-marker-container:hover .tooltip { opacity: 1; visibility: visible; }
        .info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; text-align: left; }
        .info p { margin: 5px 0; font-size: 0.9em; word-wrap: break-word; }
        .info strong { color: #1a237e; }
        .message-box { text-align: center; color: #555; font-weight: bold; margin-top: 20px; font-size: 1.1em; padding: 20px; background-color: #fafafa; border-radius: 8px; }
        .footer { font-size: 0.8em; color: #777; text-align: right; margin-top: 15px; padding-right: 5px; }
        
        /* --- ESTILOS DE LA PÁGINA DE HISTORIAL --- */
        #filtros { display: flex; gap: 20px; margin-bottom: 30px; align-items: center; }
        select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; }
        #resultados-container { display: none; }
        #mensaje { color: #555; font-size: 1.1em; text-align: center; margin-top: 20px; }
        .resumen { background-color: #fdfdfd; border: 1px solid #eaeaea; border-radius: 8px; padding: 20px; margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; }
        .resumen p { margin: 5px 0; } .resumen strong { color: #1a237e; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #1a237e; color: white; }
        tr.highlight { background-color: #dcedc8; font-weight: bold; }
        .horario-estimado { font-style: italic; color: #666; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Dashboard de Limpieza de Ductos</h1>

        <div class="tab-nav">
            <button class="tab-button active" onclick="openTab('vivo')">Seguimiento en Vivo</button>
            <button class="tab-button" onclick="openTab('historial')">Historial de Corridas</button>
        </div>

        <div id="vivo" class="tab-content active">
            <div class="tracker">
                <button id="export-pdf-btn" class="export-button" style="display: none;">Exportar Reporte</button>
                <h1>Seguimiento de Herramienta</h1>
                <div id="activa-container" style="display: none;">
                    <div id="estado-especial-container" class="estado-especial"></div>
                    <div class="progress-display">
                        <h2 id="ducto-nombre"></h2>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar" id="progress-bar-container">
                                <div id="progress-fill" class="progress"></div>
                                <div id="pig-container">
                                    <div class="pig-indicator"></div>
                                    <div class="pig-tooltip" id="pig-tooltip-text"></div>
                                </div>
                            </div>
                        </div>
                        <p class="footer">Última actualización: <span id="update-time">...</span></p>
                    </div>
                    <div class="info">
                        <p><strong>Nº Limpieza:</strong> <span id="nro-limpieza"></span></p>
                        <p><strong>Estado:</strong> <span id="estado"></span></p>
                        <p><strong>Longitud Total:</strong> <span id="longitud"></span> mts</p>
                        <p><strong>Último CP Real:</strong> <span id="ultimo-punto"></span></p>
                        <p><strong>Velocidad (est.):</strong> <span id="velocidad"></span></p>
                        <p><strong>Progresiva (est.):</strong> <span id="progresiva"></span> mts</p>
                        <p><strong>ETA Próximo CP:</strong> <span id="eta-proximo"></span></p>
                        <p><strong>ETA Receptora:</strong> <span id="eta-final"></span></p>
                        <p><strong>Método Cálculo:</strong> <span id="metodo-calculo"></span></p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Checkpoint</th><th>Progresiva [mts]</th><th>Coordenadas</th><th>Horario Pasada</th></tr></thead>
                            <tbody id="puntos-tabla-body"></tbody>
                        </table>
                    </div>
                    <div id="grafico-container" style="display: none; margin-top: 20px;">
                        <h3>Perfil de Velocidad (Tramos Reales)</h3>
                        <canvas id="velocityProfileChart"></canvas>
                    </div>
                </div>
                <div id="mensaje-container" class="message-box">
                    <p>Cargando...</p>
                </div>
            </div>
        </div>

        <div id="historial" class="tab-content">
            <div id="filtros">
                <label for="ducto-select">Ducto:</label>
                <select id="ducto-select">
                    <option value="">Cargando ductos...</option>
                </select>
                <label for="corrida-select">Nº de Corrida:</label>
                <select id="corrida-select" disabled>
                    <option value="">Seleccione un ducto primero</option>
                </select>
            </div>
            <div id="mensaje">
                <p>Seleccione un ducto y una corrida para ver los detalles.</p>
            </div>
            <div id="resultados-container">
                <div id="resumen-corrida" class="resumen"></div>
                <hr>
                <h2>Detalle de Checkpoints</h2>
                <table id="tabla-historico">
                    <thead><tr><th>Checkpoint</th><th>Progresiva [mts]</th><th>Horario Pasada</th></tr></thead>
                    <tbody></tbody>
                </table>
                <hr>
                <h2>Perfil de Velocidad</h2>
                <div id="grafico-historico-container">
                    <canvas id="velocityChartHistorico"></canvas>
                </div>
            </div>
        </div>

    </div>
    
    <div style="position: absolute; left: -9999px; top: -9999px; width: 800px; height: 450px;">
        <canvas id="pdfChartCanvas"></canvas>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby2XU-wz9PzzAMsastd-6Gwj05VNpVS8oQnwv_8UG3GxYZq5-NHYS1qLy6OF6hidExvpA/exec";

        // ======================= LÓGICA PARA CAMBIO DE SOLAPAS (TABS) =======================
        function openTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // ======================= LÓGICA PARA EL SEGUIMIENTO EN VIVO =======================
        const activaContainer = document.getElementById('activa-container');
        const mensajeContainer = document.getElementById('mensaje-container');
        const mensajeTexto = document.querySelector('#mensaje-container p');
        const updateTimeEl = document.getElementById('update-time');
        const exportBtn = document.getElementById('export-pdf-btn');
        const graficoContainer = document.getElementById('grafico-container');
        const estadoEspecialContainer = document.getElementById('estado-especial-container');
        const liveChartCanvas = document.getElementById('velocityProfileChart');
        const pdfChartCanvas = document.getElementById('pdfChartCanvas');
        let primeraCarga = true;
        let liveChart;
        let datosActualesParaReporte = null;

        exportBtn.onclick = () => {
            if (datosActualesParaReporte) {
                const nombreArchivo = `Reporte_Limpieza_${datosActualesParaReporte.numeroLimpieza}.pdf`;
                exportarReporteAPDF(datosActualesParaReporte, nombreArchivo);
            } else {
                alert("Aún no se han cargado los datos para exportar.");
            }
        };

        function drawChart(canvas, puntosDeRuta, conAnimacion = true) {
            const ctx = canvas.getContext('2d');
            const puntosReales = puntosDeRuta.filter(p => p.timestampPasada && !p.esEstimada);
            if (puntosReales.length < 2) {
                if (canvas.id === 'velocityProfileChart') graficoContainer.style.display = 'none';
                return null;
            }
            const chartLabels = [];
            const chartData = [];
            for (let i = 1; i < puntosReales.length; i++) {
                const pAnt = puntosReales[i - 1], pAct = puntosReales[i];
                const dist = pAct.progresiva - pAnt.progresiva;
                const tiempoSeg = (pAct.timestampPasada - pAnt.timestampPasada) / 1000;
                if (tiempoSeg > 0) {
                    chartLabels.push(`${pAnt.nombre} -> ${pAct.nombre}`);
                    chartData.push(((dist / tiempoSeg) * 3.6).toFixed(2));
                }
            }
            if (canvas.id === 'velocityProfileChart' && chartData.length > 0) {
                graficoContainer.style.display = 'block';
            }
            return new Chart(ctx, {
                type: 'line', data: { labels: chartLabels, datasets: [{ label: 'Velocidad (km/h)', data: chartData, borderColor: '#e53935', backgroundColor: 'rgba(229, 57, 53, 0.1)', fill: true, tension: 0.2 }] },
                options: { animation: conAnimacion ? undefined : false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        async function exportarReporteAPDF(data, nombreArchivo = 'Reporte.pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Reporte de Limpieza: ${data.nombreDucto}`, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Limpieza Nº: ${data.numeroLimpieza}`, 14, 30);
            doc.text(`Estado: ${data.estado || 'Finalizada'}`, 14, 36);
            doc.text(`Fecha de Reporte: ${new Date().toLocaleString('es-AR')}`, 14, 42);
            const head = [['Checkpoint', 'Progresiva (mts)', 'Coordenadas', 'Horario Pasada']];
            const body = data.listaDePuntos.map(p => [ p.nombre, p.progresiva.toLocaleString('es-AR'), p.coordenadas || 'N/D', p.horaPasada || '---' ]);
            doc.autoTable({ head, body, startY: 50, theme: 'striped', headStyles: { fillColor: [26, 35, 126] } });
            const pdfChart = drawChart(pdfChartCanvas, data.listaDePuntos, false);
            if (pdfChart) {
                setTimeout(() => {
                    doc.addPage();
                    doc.setFontSize(18);
                    doc.text('Gráfico de Perfil de Velocidad', 14, 22);
                    doc.addImage(pdfChart.toBase64Image(), 'PNG', 14, 30, 180, 100);
                    doc.save(nombreArchivo);
                    pdfChart.destroy();
                }, 250);
            } else { doc.save(nombreArchivo); }
        }

        async function generarReporteFinal(idLimpieza) {
            const boton = document.getElementById('final-report-btn');
            boton.textContent = 'Generando...';
            boton.disabled = true;
            try {
                const response = await fetch(`${SCRIPT_URL}?id=${idLimpieza}`);
                if (!response.ok) throw new Error('No se pudo obtener el detalle.');
                const data = await response.json();
                if(data.error) throw new Error(data.error);
                exportarReporteAPDF(data, `Reporte_Final_Limpieza_${data.numeroLimpieza}.pdf`);
            } catch(error) {
               alert(`Error al generar el reporte: ${error.message}`);
            } finally {
                boton.textContent = 'Generar Reporte Final';
                boton.disabled = false;
            }
        }
        
        async function actualizarProgreso() {
            try {
                estadoEspecialContainer.style.display = 'none';
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`Error de red: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                if (data.idLimpieza) {
                    datosActualesParaReporte = data;
                    activaContainer.style.display = 'block';
                    mensajeContainer.style.display = 'none';
                    if (data.estado === "Llegada Estimada") {
                        estadoEspecialContainer.innerHTML = 'Limpieza finalizada por estimación. Esperando confirmación en Receptora...';
                        estadoEspecialContainer.style.display = 'block';
                    }
                    exportBtn.style.display = data.estado === "En Curso" ? 'block' : 'none';
                    const { numeroLimpieza, nombreDucto, estado, ultimoPunto, estimacion, avance, listaDePuntos, longitudTotalMts } = data;
                    document.getElementById('ducto-nombre').textContent = nombreDucto;
                    document.getElementById('nro-limpieza').textContent = numeroLimpieza;
                    document.getElementById('estado').textContent = estado;
                    document.getElementById('longitud').textContent = longitudTotalMts.toLocaleString('es-AR');
                    document.getElementById('ultimo-punto').textContent = ultimoPunto.nombre;
                    document.getElementById('progresiva').textContent = Math.round(estimacion.progresivaEstimadaMts).toLocaleString('es-AR');
                    const velKmH = estimacion.velocidad_ms ? (estimacion.velocidad_ms * 3.6) : 0;
                    document.getElementById('velocidad').textContent = estimacion.velocidad_ms ? `${velKmH.toFixed(2)} km/h (${estimacion.velocidad_ms.toFixed(2)} m/s)`: '---';
                    document.getElementById('eta-proximo').textContent = estimacion.etaProximo ? `${estimacion.etaProximo.nombre} ${estimacion.etaProximo.hora}` : '---';
                    document.getElementById('eta-final').textContent = estimacion.etaFinal ? `${estimacion.etaFinal.hora}` : '---';
                    document.getElementById('metodo-calculo').textContent = estimacion.metodoCalculo;
                    document.getElementById('progress-fill').style.width = avance.porcentaje + '%';
                    document.getElementById('progress-fill').textContent = avance.porcentaje.toFixed(1) + '%';
                    document.getElementById('pig-container').style.left = `calc(${avance.porcentaje}% - 10.5px)`;
                    document.getElementById('pig-tooltip-text').textContent = `${Math.round(estimacion.progresivaEstimadaMts).toLocaleString('es-AR')} mts`;
                    if(primeraCarga) {
                        const wrapper = document.querySelector('.progress-bar-wrapper');
                        wrapper.scrollTo({ left: (wrapper.scrollWidth * (avance.porcentaje / 100)) - (wrapper.clientWidth / 2) , behavior: 'auto' });
                    }
                    const tablaBody = document.getElementById('puntos-tabla-body');
                    const progressBar = document.getElementById('progress-bar-container');
                    progressBar.querySelectorAll('.checkpoint-marker-container').forEach(el => el.remove());
                    tablaBody.innerHTML = '';
                    listaDePuntos.forEach(punto => {
                        const percent = (punto.progresiva / longitudTotalMts) * 100;
                        const markerContainer = document.createElement('div');
                        markerContainer.className = 'checkpoint-marker-container';
                        markerContainer.style.left = percent + '%';
                        markerContainer.innerHTML = `<div class="checkpoint-marker"></div><div class="tooltip">${punto.nombre} | ${(punto.progresiva / 1000).toFixed(2)} km</div>`;
                        progressBar.appendChild(markerContainer);
                        const row = document.createElement('tr');
                        let horarioHtml = punto.horaPasada ? (punto.horaPasada.includes('(') ? `<span class="horario-estimado">${punto.horaPasada}</span>` : punto.horaPasada) : '---';
                        row.innerHTML = `<td>${punto.nombre}</td><td>${punto.progresiva.toLocaleString('es-AR')}</td><td>${punto.coordenadas || ''}</td><td>${horarioHtml}</td>`;
                        if (ultimoPunto.nombre === punto.nombre) row.classList.add('highlight');
                        tablaBody.appendChild(row);
                    });
                    if (liveChart) liveChart.destroy();
                    liveChart = drawChart(liveChartCanvas, listaDePuntos, true);
                } else if (data.ultimaCorrida) {
                    activaContainer.style.display = 'none';
                    mensajeContainer.style.display = 'block';
                    const uc = data.ultimaCorrida;
                    mensajeTexto.innerHTML = `No hay limpiezas activas.<br><br><strong>Última corrida finalizada:</strong><br>Nº: ${uc.numeroLimpieza} | Ducto: ${uc.nombreDucto}<br>Finalizó el ${uc.fecha} a las ${uc.hora} hs.<br>Duración Total: ${uc.duracion}`;
                    if (!document.getElementById('final-report-btn')) {
                        const btn = document.createElement('button');
                        btn.id = 'final-report-btn';
                        btn.className = 'export-button final-report-button';
                        btn.textContent = 'Generar Reporte Final';
                        btn.onclick = () => generarReporteFinal(uc.idLimpieza);
                        mensajeContainer.appendChild(btn);
                    }
                } else { throw new Error("No se recibieron datos válidos."); }
            } catch (error) {
                activaContainer.style.display = 'none';
                mensajeContainer.style.display = 'block';
                mensajeTexto.textContent = `Error: ${error.message}`;
                console.error(error);
            } finally {
                primeraCarga = false;
                updateTimeEl.textContent = new Date().toLocaleTimeString('es-AR', { hour12: false });
            }
        }
        
        // ======================= LÓGICA PARA EL HISTORIAL DE CORRIDAS =======================
        const ductoSelect = document.getElementById('ducto-select');
        const corridaSelect = document.getElementById('corrida-select');
        const resultadosContainer = document.getElementById('resultados-container');
        const resumenDiv = document.getElementById('resumen-corrida');
        const tablaBodyHistorial = document.querySelector('#tabla-historico tbody');
        const mensajeDiv = document.getElementById('mensaje');
        const chartCanvasHistorial = document.getElementById('velocityChartHistorico');
        let historicoChart;

        async function cargarDuctos() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getDuctos`);
                if (!response.ok) throw new Error('No se pudo cargar la lista de ductos.');
                const ductos = await response.json();
                ductoSelect.innerHTML = '<option value="">Seleccione un ducto</option>';
                ductos.forEach(d => {
                    ductoSelect.innerHTML += `<option value="${d.id}">${d.nombre}</option>`;
                });
            } catch (error) {
                mensajeDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        async function cargarCorridas() {
            const ductoId = ductoSelect.value;
            resultadosContainer.style.display = 'none';
            corridaSelect.disabled = true;
            corridaSelect.innerHTML = '<option value="">Cargando corridas...</option>';
            mensajeDiv.style.display = 'block';
            mensajeDiv.innerHTML = '<p>Seleccione un ducto y una corrida para ver los detalles.</p>';
            if (!ductoId) {
                corridaSelect.innerHTML = '<option value="">Seleccione un ducto primero</option>';
                return;
            }
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getCorridas&id=${ductoId}`);
                if (!response.ok) throw new Error('No se pudo cargar la lista de corridas.');
                const corridas = await response.json();
                if (corridas.length === 0) {
                    corridaSelect.innerHTML = '<option value="">No hay corridas para este ducto</option>';
                    return;
                }
                corridaSelect.innerHTML = '<option value="">Seleccione una corrida</option>';
                corridas.forEach(c => {
                    corridaSelect.innerHTML += `<option value="${c.id}">Nº ${c.nro} (${c.fecha})</option>`;
                });
                corridaSelect.disabled = false;
            } catch (error) {
                mensajeDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        async function cargarResultados() {
            const corridaId = corridaSelect.value;
            if (!corridaId) {
                resultadosContainer.style.display = 'none';
                mensajeDiv.style.display = 'block';
                return;
            }
            mensajeDiv.innerHTML = '<p>Cargando datos de la corrida...</p>';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getHistorico&id=${corridaId}`);
                if (!response.ok) throw new Error('No se pudieron cargar los datos históricos.');
                const data = await response.json();
                resumenDiv.innerHTML = `<p><strong>Ducto:</strong> ${data.resumen.nombreDucto}</p><p><strong>Nº Limpieza:</strong> ${data.resumen.nroLimpieza}</p><p><strong>Fecha:</strong> ${data.resumen.fecha}</p><p><strong>Duración Total:</strong> ${data.resumen.duracion}</p>`;
                tablaBodyHistorial.innerHTML = '';
                data.tabla.forEach(cp => {
                    tablaBodyHistorial.innerHTML += `<tr><td>${cp.nombre}</td><td>${cp.progresiva.toLocaleString('es-AR')}</td><td>${cp.horario}</td></tr>`;
                });
                drawHistoricoChart(data.checkpoints);
                mensajeDiv.style.display = 'none';
                resultadosContainer.style.display = 'block';
            } catch (error) {
                mensajeDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                resultadosContainer.style.display = 'none';
            }
        }
        
        function drawHistoricoChart(checkpoints) {
            if (historicoChart) historicoChart.destroy();
            if (!checkpoints || checkpoints.length < 2) return;
            const labels = [], data = [];
            for (let i = 1; i < checkpoints.length; i++) {
                const pAnt = checkpoints[i-1], pAct = checkpoints[i];
                const dist = pAct.progresiva_mts - pAnt.progresiva_mts;
                const tiempoSeg = (new Date(pAct.fechaHora).getTime() - new Date(pAnt.fechaHora).getTime()) / 1000;
                if (tiempoSeg > 0) {
                    labels.push(`${pAnt.nombre} -> ${pAct.nombre}`);
                    data.push(((dist / tiempoSeg) * 3.6).toFixed(2));
                }
            }
            historicoChart = new Chart(chartCanvasHistorial, {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Velocidad (km/h)',
                            data: data,
                            backgroundColor: 'rgba(26, 35, 126, 0.6)',
                            order: 2
                        },
                        {
                            type: 'line',
                            label: 'Tendencia',
                            data: data,
                            borderColor: '#e53935',
                            fill: false,
                            tension: 0.1,
                            order: 1
                        }
                    ] 
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Velocidad (km/h)'} } }, plugins: { legend: { display: false } } }
            });
        }

        // ======================= INICIALIZACIÓN Y EVENTOS =======================
        ductoSelect.addEventListener('change', cargarCorridas);
        corridaSelect.addEventListener('change', cargarResultados);
        
        document.addEventListener('DOMContentLoaded', () => {
            actualizarProgreso();
            setInterval(actualizarProgreso, 30000);
            cargarDuctos();
        });
    </script>
</body>
</html>